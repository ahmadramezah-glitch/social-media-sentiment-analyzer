{% extends "base.html" %}

{% block title %}Twitter Hashtag Search - Instagram Sentiment Analyzer{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fab fa-twitter text-primary me-2"></i>
                    Twitter Hashtag Search
                </h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                        <li class="breadcrumb-item active">Twitter Search</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Search Form -->
        <div class="col-lg-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-search me-2"></i>
                        Search Twitter Hashtags
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('twitter_search') }}" id="twitterSearchForm">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label for="hashtag" class="form-label">
                                        <i class="fas fa-hashtag me-2"></i>
                                        Hashtag to Search
                                    </label>
                                    <input type="text" 
                                           class="form-control form-control-lg" 
                                           id="hashtag" 
                                           name="hashtag" 
                                           placeholder="Enter hashtag (without #)" 
                                           required>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Enter a hashtag without the # symbol (e.g., "technology" for #technology)
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary btn-lg w-100" id="searchBtn">
                                    <i class="fas fa-search me-2"></i>
                                    Search Twitter
                                </button>
                            </div>
                        </div>
                        
                        <!-- Clear Search Button -->
                        <div class="row mt-3">
                            <div class="col-md-8 offset-md-4">
                                <a href="{{ url_for('clear_twitter_session') }}" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-eraser me-2"></i>
                                    Clear Search & Start Fresh
                                </a>
                                <small class="text-muted ms-2">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Use this if you see old results
                                </small>
                            </div>
                        </div>
                        
                        <!-- Loading Progress Bar -->
                        <div id="loadingProgress" class="mt-3" style="display: none;">
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                     role="progressbar" 
                                     style="width: 0%" 
                                     id="progressBar">
                                    <span id="progressText">Starting search...</span>
                                </div>
                            </div>
                            <div class="text-center mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    Twitter search should now complete in 1-3 minutes with optimized processing
                                </small>
                            </div>
                        </div>
                    </form>
                    
                                         <!-- View Results Button -->
                     <div class="row mt-3" id="viewResultsSection" style="display: none;">
                         <div class="col-md-8 offset-md-4">
                             {% set current_session_id = session.get('current_session_id', '') %}
                             <a href="{{ url_for('twitter_results', session_id=current_session_id) if current_session_id else url_for('twitter_results') }}" class="btn btn-success btn-lg w-100" id="viewResultsBtn">
                                 <i class="fas fa-eye me-2"></i>
                                 View Results for #<span id="resultHashtag">hashtag</span>
                             </a>
                             <small class="text-muted mt-2 d-block text-center">
                                 <i class="fas fa-check-circle me-1"></i>
                                 Search completed! Found <span id="resultTweetCount">0</span> tweets. Click to view your Twitter analysis results.
                             </small>
                         </div>
                     </div>
                    
                                         <!-- Existing Results Notice -->
                     {% if session.get('search_success') %}
                     <div class="row mt-3" id="existingResultsSection">
                         <div class="col-md-8 offset-md-4">
                             <div class="alert alert-success">
                                 <i class="fas fa-check-circle me-2"></i>
                                 <strong>Search Results Available!</strong> You have results for #{{ session.get('search_hashtag', 'hashtag') }} 
                                 ({{ session.get('search_tweet_count', 0) }} tweets). 
                                 {% set current_session_id = session.get('current_session_id', '') %}
                                 <a href="{{ url_for('twitter_results', session_id=current_session_id) if current_session_id else url_for('twitter_results') }}" class="btn btn-success btn-sm ms-2">
                                     <i class="fas fa-eye me-1"></i>View Results
                                 </a>
                             </div>
                         </div>
                     </div>
                     {% endif %}
                    
                    <!-- Optimization Notice -->
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-rocket me-2"></i>
                        <strong>Optimized for Speed:</strong> This search will process up to 15+ tweets with up to 3 comments each to provide faster results while avoiding Twitter API rate limits.
                    </div>
                </div>
            </div>

            <!-- Features Info -->
            <div class="card mt-4 shadow-sm border-0">
                <div class="card-header bg-gradient-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-star me-2"></i>
                        What You'll Get
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="fas fa-comments text-primary"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">Tweet Analysis</h6>
                                    <small class="text-muted">Sentiment analysis of each tweet</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-success bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="fas fa-heart text-success"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">Like Counts</h6>
                                    <small class="text-muted">Number of likes for each tweet</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-warning bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="fas fa-reply text-warning"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">Comments & Replies</h6>
                                    <small class="text-muted">All comments with sentiment analysis</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-info bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="fas fa-chart-line text-info"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">Overall Sentiment</h6>
                                    <small class="text-muted">Combined sentiment of tweets & comments</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Stats -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-gradient-secondary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Twitter API Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-success bg-opacity-10 rounded-circle p-2 me-3">
                            <i class="fas fa-check-circle text-success"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">API Connected</h6>
                            <small class="text-muted">Twitter API v2 Ready</small>
                        </div>
                    </div>
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-info bg-opacity-10 rounded-circle p-2 me-3">
                            <i class="fas fa-clock text-info"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">Recent Tweets</h6>
                            <small class="text-muted">Last 7 days</small>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="bg-warning bg-opacity-10 rounded-circle p-2 me-3">
                            <i class="fas fa-language text-warning"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">Language Filter</h6>
                            <small class="text-muted">English tweets only</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Export Options -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-gradient-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-download me-2"></i>
                        Export Options
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        After searching, you can export your Twitter analysis data in multiple formats.
                    </p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" disabled>
                            <i class="fas fa-file-excel me-2"></i>
                            Export to Excel
                        </button>
                        <button class="btn btn-outline-danger" disabled>
                            <i class="fas fa-file-pdf me-2"></i>
                            Export to PDF
                        </button>
                    </div>
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Export buttons will be enabled after search
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Searches (if any) -->
    {% if session.get('twitter_hashtag') %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-gradient-warning text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>
                        Recent Search
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Last searched hashtag: <span class="badge bg-primary">#{{ session.get('twitter_hashtag') }}</span></h6>
                            <small class="text-muted">Click below to view results or search for a new hashtag</small>
                        </div>
                                                 {% set current_session_id = session.get('current_session_id', '') %}
                                                 <a href="{{ url_for('twitter_results', session_id=current_session_id) if current_session_id else url_for('twitter_results') }}" class="btn btn-primary">
                             <i class="fas fa-eye me-2"></i>
                             View Results
                         </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.bg-gradient-primary {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)) !important;
}

.bg-gradient-info {
    background: linear-gradient(135deg, var(--accent-color), var(--primary-color)) !important;
}

.bg-gradient-secondary {
    background: linear-gradient(135deg, var(--secondary-color), var(--dark-color)) !important;
}

.bg-gradient-success {
    background: linear-gradient(135deg, var(--success-color), var(--primary-color)) !important;
}

.bg-gradient-warning {
    background: linear-gradient(135deg, #ffc107, #fd7e14) !important;
}

.card {
    border-radius: 15px;
    overflow: hidden;
}

.card-header {
    border-bottom: none;
    padding: 1.5rem;
}

.form-control-lg {
    border-radius: 10px;
    border: 2px solid var(--border-color);
    transition: all 0.3s ease;
}

.form-control-lg:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(0, 168, 232, 0.25);
}

.btn-lg {
    border-radius: 10px;
    padding: 12px 24px;
    font-weight: 600;
}

.bg-opacity-10 {
    --bs-bg-opacity: 0.1;
}

.rounded-circle {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('twitterSearchForm');
    const searchBtn = document.getElementById('searchBtn');
    const loadingProgress = document.getElementById('loadingProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const viewResultsSection = document.getElementById('viewResultsSection');
    
    // Check if we have search results in the URL (redirected from search)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('search_completed') === 'true') {
        showViewResultsButton();
    }
    
    // Check if we have existing results in the page
    const existingResultsSection = document.getElementById('existingResultsSection');
    if (existingResultsSection && existingResultsSection.style.display !== 'none') {
        showViewResultsButton();
    }
    
    form.addEventListener('submit', function(e) {
        // Show loading progress
        loadingProgress.style.display = 'block';
        searchBtn.disabled = true;
        searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Searching...';
        
        // Simulate progress updates
        let progress = 0;
        const progressInterval = setInterval(function() {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90; // Don't go to 100% until actually complete
            
            progressBar.style.width = progress + '%';
            
            if (progress < 30) {
                progressText.textContent = 'Searching Twitter...';
            } else if (progress < 60) {
                progressText.textContent = 'Fetching tweets...';
            } else if (progress < 90) {
                progressText.textContent = 'Analyzing sentiment...';
            }
        }, 2000); // Update every 2 seconds
        
        // Store interval ID to clear later
        form.dataset.progressInterval = progressInterval;
        
        // Form will submit normally, this just shows progress
    });
    
    function showViewResultsButton() {
        if (viewResultsSection) {
            viewResultsSection.style.display = 'block';
            
            // Update the hashtag and tweet count if available
            const resultHashtag = document.getElementById('resultHashtag');
            const resultTweetCount = document.getElementById('resultTweetCount');
            
            // Try to get data from session storage or URL params
            const urlParams = new URLSearchParams(window.location.search);
            const hashtag = urlParams.get('hashtag') || 'hashtag';
            const tweetCount = urlParams.get('tweet_count') || '0';
            
            if (resultHashtag) resultHashtag.textContent = hashtag;
            if (resultTweetCount) resultTweetCount.textContent = tweetCount;
            
            // Scroll to the button
            viewResultsSection.scrollIntoView({ behavior: 'smooth' });
        }
    }
    
    // Listen for messages from the results page
    window.addEventListener('message', function(event) {
        if (event.data.type === 'SEARCH_COMPLETED') {
            showViewResultsButton();
        }
    });
});
</script>
{% endblock %}
